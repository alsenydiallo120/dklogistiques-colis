version: "3.9"
services:
  webapp:
    build:
      dockerfile: Dockerfile
    image: webapp
    restart: unless-stopped
    command: gunicorn --workers=3 CGEI.wsgi:application --bind 0.0.0.0:8001
    expose:
      - 8001
    ports:
      - "8001:8001"
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/mediafiles
      - /data/coolify/proxy/dynamic:/app/dynamic
    environment:
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - DATABASE_URL=${DATABASE_URL}
      - DJANGO_SUPERUSER_USERNAME=${DJANGO_SUPERUSER_USERNAME}
      - DJANGO_SUPERUSER_PASSWORD=${DJANGO_SUPERUSER_PASSWORD}
      - DJANGO_ENV=${DJANGO_ENV}
      - DEBUG=${DEBUG}

  phpmyadmin:
    image: 'lscr.io/linuxserver/phpmyadmin:latest'
    environment:
      - SERVICE_FQDN_PHPMYADMIN
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - PMA_ARBITRARY=1
      - PMA_ABSOLUTE_URI=$SERVICE_FQDN_PHPMYADMIN
    volumes:
      - 'phpmyadmin-config:/config'
      - './99-custom.ini:/etc/php81/php.ini'  # <-- Monte le fichier de config PHP
    healthcheck:
      test:
        - CMD
        - curl
        - '-f'
        - 'http://127.0.0.1:80'
      interval: 2s
      timeout: 10s
      retries: 15

volumes:
  static_volume:
  media_volume:
  phpmyadmin-config:
